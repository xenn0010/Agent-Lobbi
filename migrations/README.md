# Agent Ecosystem Database Migrations

This directory contains database migration scripts managed by Alembic. Alembic allows for incremental, versioned updates to the PostgreSQL database schema.

## Requirements

- Alembic: `pip install alembic`
- PostgreSQL database server
- Correct database connection string in `alembic.ini` (or configured dynamically in `env.py`)

## Common Commands

All commands should be run from the project root directory.

**1. Create a new migration:**

   When you make changes to the SQLAlchemy models in `src/core/database.py` (e.g., add a table, add a column), you need to generate a new migration script.

   ```bash
   python -m alembic revision -m "short_description_of_changes"
   ```

   This will create a new file in `migrations/versions/`. You should then edit this file to include the `op.create_table()`, `op.add_column()`, etc. commands that reflect your model changes.
   Alembic can sometimes autogenerate these changes, but it's best to review and adjust them.

**2. Apply migrations (upgrade to the latest version):**

   This command applies all pending migrations to your database.

   ```bash
   python -m alembic upgrade head
   ```

**3. Downgrade migrations:**

   - To downgrade by one version:
     ```bash
     python -m alembic downgrade -1
     ```
   - To downgrade to a specific version (replace `<revision_id>`):
     ```bash
     python -m alembic downgrade <revision_id>
     ```
   - To downgrade to the base (no migrations applied):
     ```bash
     python -m alembic downgrade base
     ```

**4. Show current revision:**

   Displays the current revision applied to the database.

   ```bash
   python -m alembic current
   ```

**5. Show migration history:**

   Lists all migration scripts and their status.

   ```bash
   python -m alembic history
   ```

**6. Autogenerate a migration (experimental, review carefully):**

   Alembic can attempt to automatically generate migration scripts based on the differences between your current database schema and your SQLAlchemy models.

   ```bash
   python -m alembic revision --autogenerate -m "autogenerated_description"
   ```

   **Important:** Always review autogenerated scripts carefully before applying them. They might not always capture your intent perfectly.

## Configuration

- **`alembic.ini`**: Main configuration file for Alembic. Contains the database URL and other settings.
- **`migrations/env.py`**: Python script that configures how Alembic connects to the database and accesses your SQLAlchemy models. This has been set up to use the application's configuration from `src/core/config.py`.

## Workflow

1.  Modify your SQLAlchemy models in `src/core/database.py`.
2.  Generate a new migration script: `python -m alembic revision -m "description"`.
3.  Edit the new script in `migrations/versions/` to define the `upgrade()` and `downgrade()` operations.
4.  Apply the migration: `python -m alembic upgrade head`.
5.  Commit the `alembic.ini`, `migrations/` directory (including `env.py`, `script.py.mako`, and the `versions/` subdirectory) to your version control system.

## Troubleshooting

- **"Target database is not up to date."**: Run `python -m alembic upgrade head`.
- **"Can't locate revision identified by..."**: Ensure your revision IDs in the scripts are correct and that there are no conflicts.
- **ModuleNotFoundError for your project's modules**: Ensure that `migrations/env.py` correctly adds your project's root directory to `sys.path` so it can find `src.core.database` and `src.core.config`. 